<!-- diagram-editor.component.html -->
<div class="main-container">
  <!-- Botón hamburguesa -->
  <button class="hamburger-btn" (click)="toggleSidebar()" [class.active]="sidebarOpen">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <!-- Overlay para cerrar menú solo en móviles -->
  <div *ngIf="sidebarOpen" class="sidebar-overlay" (click)="toggleSidebar()"></div>

  <!-- Panel lateral colapsible -->
  <div class="sidebar" [class.open]="sidebarOpen">
    <!-- Sección de Controles -->
    <div class="sidebar-section">
      <h3 class="section-title">
        <mat-icon>settings</mat-icon>
        <span>Controles</span>
      </h3>

      <!-- Controles básicos -->
      <button (click)="addEntity()" class="btn-sidebar btn-primary">
        <mat-icon>add_box</mat-icon>
        <span>Añadir Entidad</span>
      </button>

      <button
        (click)="deleteSelected()"
        class="btn-sidebar btn-danger"
        [disabled]="!selectedEntity && !selectedLink">
        <mat-icon>delete</mat-icon>
        <span>Eliminar Selección</span>
      </button>

      <button (click)="updateDiagram()" class="btn-sidebar btn-success">
        <mat-icon>save</mat-icon>
        <span>Guardar Diagrama</span>
      </button>

      <!-- Controles de entidad seleccionada -->
      <div *ngIf="selectedEntity" class="entity-controls">
        <h4 class="control-section-title">Entidad: {{ selectedEntity.data.name }}</h4>

        <button (click)="openEditDialog()" class="btn-sidebar btn-edit">
          <mat-icon>edit</mat-icon>
          <span>Editar Entidad</span>
        </button>
      </div>

      <!-- Controles generales -->
      <div class="general-controls">
        <button (click)="goBack()" class="btn-sidebar btn-back">
          <mat-icon>arrow_back</mat-icon>
          <span>Volver Atrás</span>
        </button>

        <button
          (click)="deactivateRelationMode()"
          class="btn-sidebar btn-secondary"
          [disabled]="!isCreatingRelation">
          <mat-icon>close</mat-icon>
          <span>Desactivar Relación</span>
        </button>

        <button
          (click)="exportBackend()"
          class="btn-sidebar btn-secondary">
          <mat-icon>call_made</mat-icon>
          <span>Export Backend</span>
        </button>
      </div>
    </div>

    <!-- Separador -->
    <div class="sidebar-separator"></div>

    <!-- Sección de Relaciones -->
    <div class="sidebar-section">
      <h3 class="section-title">
        <mat-icon>link</mat-icon>
        <span>Relaciones</span>
      </h3>

      <div class="relations-grid">
        <button
          (click)="selectRelationship('OneToOne')"
          [class]="['btn-relation', { active: relationMode === 'OneToOne' }]">
          <mat-icon>trending_flat</mat-icon>
          <span class="relation-text">1 a 1</span>
        </button>

        <button
          (click)="selectRelationship('OneToMany')"
          [class]="['btn-relation', { active: relationMode === 'OneToMany' }]">
          <mat-icon>call_split</mat-icon>
          <span class="relation-text">1 a Muchos</span>
        </button>

        <button
          (click)="selectRelationship('ManyToMany')"
          [class]="['btn-relation', { active: relationMode === 'ManyToMany' }]">
          <mat-icon>hub</mat-icon>
          <span class="relation-text">Muchos a Muchos</span>
        </button>

        <button
          (click)="selectRelationship('Generalizacion')"
          [class]="['btn-relation', { active: relationMode === 'Generalizacion' }]">
          <mat-icon>account_tree</mat-icon>
          <span class="relation-text">Generalización</span>
        </button>

        <button
          (click)="selectRelationship('Agregacion')"
          [class]="['btn-relation', { active: relationMode === 'Agregacion' }]">
          <mat-icon>radio_button_unchecked</mat-icon>
          <span class="relation-text">Agregación</span>
        </button>

        <button
          (click)="selectRelationship('Composicion')"
          [class]="['btn-relation', { active: relationMode === 'Composicion' }]">
          <mat-icon>lens</mat-icon>
          <span class="relation-text">Composición</span>
        </button>

        <button
          (click)="selectRelationship('Recursividad')"
          [class]="['btn-relation', { active: relationMode === 'Recursividad' }]">
          <mat-icon>refresh</mat-icon>
          <span class="relation-text">Recursividad</span>
        </button>
      </div>

      <!-- Estado de relaciones -->
      <div *ngIf="isCreatingRelation" class="relation-status">
        <div class="status-active">
          <mat-icon>radio_button_checked</mat-icon>
          <span>Modo <strong>{{ selectedRelationship }}</strong> activo</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Área del diagrama -->
  <div class="diagram-container" [class.sidebar-open]="sidebarOpen">
    <!-- Indicadores de estado -->
    <div class="status-indicators">
      <div *ngIf="relationMode" class="relation-indicator">
        <mat-icon>link</mat-icon>
        <span>Modo activo: <strong>{{ relationMode }}</strong> - Arrastra desde un puerto a otro</span>
      </div>

      <div *ngIf="resizeMode" class="resize-indicator">
        <mat-icon>crop_free</mat-icon>
        <span>Modo redimensionar activo - Haz clic y arrastra en una entidad</span>
      </div>

      <div *ngIf="selectedEntity" class="selection-indicator">
        <mat-icon>check_circle</mat-icon>
        <span>Entidad seleccionada: <strong>{{ selectedEntity.data.name }}</strong></span>
      </div>
    </div>

    <!-- Área del diagrama -->
    <div #diagramDiv class="diagram"></div>
  </div>

  <!-- Modal para editar entidad -->
  <div *ngIf="showModal" class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">
          <mat-icon>edit</mat-icon>
          <span>Editar Entidad</span>
        </h3>
        <button (click)="closeModal()" class="btn-close">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <!-- FORMULARIO REACTIVO PRINCIPAL -->
      <form class="modal-body" [formGroup]="entityForm">
        <!-- Nombre de la entidad -->
        <div class="form-section">
          <label class="form-label">Nombre de la Entidad</label>
          <mat-form-field appearance="outline" class="full-width">
            <input matInput formControlName="name" placeholder="Ingrese el nombre" />
            <mat-error *ngIf="entityForm.get('name')?.hasError('required')">
              El nombre es obligatorio.
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Sección de Atributos -->
        <div class="form-section">
          <h4 class="section-title">
            <mat-icon>view_list</mat-icon>
            <span>Atributos</span>
          </h4>

          <!-- NUEVO atributo -->
          <div [formGroup]="newAttributeForm" class="attribute-form">
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Nombre del Atributo</mat-label>
                <input matInput formControlName="name" placeholder="Nombre" />
                <mat-error *ngIf="newAttributeForm.get('name')?.hasError('required')">
                  Requerido
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Tipo</mat-label>
                <mat-select formControlName="type">
                  <mat-option *ngFor="let t of attributeTypes" [value]="t">{{ t }}</mat-option>
                </mat-select>
                <mat-error *ngIf="newAttributeForm.get('type')?.hasError('required')">
                  Selecciona un tipo
                </mat-error>
              </mat-form-field>
            </div>

            <div class="checkbox-row">
              <mat-checkbox formControlName="primaryKey" color="primary">
                Primary Key [PK]
              </mat-checkbox>

              <mat-checkbox formControlName="foreignKey" color="accent">
                Foreign Key [FK]
              </mat-checkbox>
            </div>

            <button
              mat-raised-button
              color="primary"
              type="button"
              (click)="addAttributeFromForm()"
              [disabled]="newAttributeForm.invalid"
              class="btn-add">
              <mat-icon>add</mat-icon>
              <span>Agregar Atributo</span>
            </button>
          </div>

          <!-- Lista de atributos existentes -->
          <div *ngIf="attributesFA.controls.length > 0" class="items-list">
            <h5 class="list-title">
              <mat-icon>list</mat-icon>
              <span>Atributos existentes ({{ attributesFA.controls.length }})</span>
            </h5>

            <div class="items-container">
              <mat-card
                *ngFor="let attr of attributesFA.controls; let i = index"
                class="item-card attribute-card">
                <mat-card-content class="item-content">
                  <div class="item-info">
                    <span class="item-name">{{ attr.get('name')?.value }}</span>
                    <span class="item-type">{{ attr.get('type')?.value }}</span>
                    <div class="item-badges">
                      <mat-chip *ngIf="attr.get('primaryKey')?.value" color="primary">PK</mat-chip>
                      <mat-chip *ngIf="attr.get('foreignKey')?.value" color="accent">FK</mat-chip>
                    </div>
                  </div>
                  <button
                    mat-icon-button
                    color="warn"
                    (click)="removeAttribute(i)"
                    class="btn-remove">
                    <mat-icon>delete</mat-icon>
                  </button>
                </mat-card-content>
              </mat-card>
            </div>
          </div>
        </div>

        <!-- Sección de Métodos -->
        <div class="form-section">
          <h4 class="section-title">
            <mat-icon>functions</mat-icon>
            <span>Métodos</span>
          </h4>

          <!-- NUEVO método -->
          <div [formGroup]="newMethodForm" class="method-form">
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Nombre del Método</mat-label>
                <input matInput formControlName="name" placeholder="Nombre" />
                <mat-error *ngIf="newMethodForm.get('name')?.hasError('required')">
                  Requerido
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Tipo de Retorno</mat-label>
                <mat-select formControlName="type">
                  <mat-option *ngFor="let t of methodReturnTypes" [value]="t">{{ t }}</mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Visibilidad</mat-label>
                <mat-select formControlName="visibility">
                  <mat-option *ngFor="let v of methodVisibilities" [value]="v">{{ v }}</mat-option>
                </mat-select>
              </mat-form-field>
            </div>

            <button
              mat-raised-button
              color="primary"
              type="button"
              (click)="addMethodFromForm()"
              [disabled]="newMethodForm.invalid"
              class="btn-add">
              <mat-icon>add</mat-icon>
              <span>Agregar Método</span>
            </button>
          </div>

          <!-- Lista de métodos existentes -->
          <div *ngIf="methodsFA.controls.length > 0" class="items-list">
            <h5 class="list-title">
              <mat-icon>list</mat-icon>
              <span>Métodos existentes ({{ methodsFA.controls.length }})</span>
            </h5>
            <div class="items-container">
              <mat-card
                *ngFor="let method of methodsFA.controls; let i = index"
                class="item-card method-card">
                <mat-card-content class="item-content">
                  <div class="item-info">
                    <mat-chip
                      [color]="method.get('visibility')?.value === 'public' ? 'primary'
                               : method.get('visibility')?.value === 'private' ? 'warn' : 'accent'">
                      {{ method.get('visibility')?.value }}
                    </mat-chip>
                    <span class="item-name">{{ method.get('name')?.value }}()</span>
                    <span class="item-type">{{ method.get('type')?.value }}</span>
                  </div>
                  <button
                    mat-icon-button
                    color="warn"
                    (click)="removeMethod(i)"
                    class="btn-remove">
                    <mat-icon>delete</mat-icon>
                  </button>
                </mat-card-content>
              </mat-card>
            </div>
          </div>
        </div>
      </form>

      <!-- Acciones del modal -->
      <div class="modal-footer">
        <button mat-raised-button color="primary" (click)="saveEntity()" class="btn-modal">
          <mat-icon>save</mat-icon>
          <span>Guardar Cambios</span>
        </button>
        <button mat-button (click)="closeModal()" class="btn-modal">
          <mat-icon>cancel</mat-icon>
          <span>Cancelar</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de carga para exportación -->
  <div *ngIf="isExporting" class="modal-overlay loading-overlay">
    <div class="loading-modal">
      <div class="loading-content">
        <mat-spinner diameter="60"></mat-spinner>
        <h3 class="loading-title">Generando Backend</h3>
        <p class="loading-description">
          JHipster está generando tu backend... Esto puede tardar 1-2 minutos.
        </p>
        <div class="loading-progress">
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
          <p class="progress-text">Por favor no cierres ni actualices la página</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== WIDGET CHAT IA (flotante) ===================== -->
  <button class="ai-fab" (click)="toggleAi()" [attr.aria-expanded]="aiOpen" aria-label="Abrir asistente IA">
    <mat-icon *ngIf="!aiOpen">support_agent</mat-icon>
    <mat-icon *ngIf="aiOpen">close</mat-icon>
  </button>

  <section class="ai-panel" [class.open]="aiOpen" aria-label="Panel asistente IA">
    <header class="ai-header">
      <div class="ai-title">
        <mat-icon>auto_awesome</mat-icon><span>Asistente IA</span>
      </div>
      <button class="ai-close" (click)="toggleAi()" aria-label="Cerrar"><mat-icon>close</mat-icon></button>
    </header>

    <div class="ai-body">
      <div class="ai-messages" #aiScroll>
        <!-- Historial -->
        <div *ngFor="let m of aiMessages" class="ai-msg" [class.you]="m.role==='user'" [class.ai]="m.role==='ai'">
          <div class="ai-bubble">
            <div class="ai-text" [innerText]="m.text"></div>
            <div class="ai-suggestions" *ngIf="m.suggestions?.length">
              <div class="suggestion" *ngFor="let s of m.suggestions">{{ s }}</div>
            </div>
          </div>
        </div>

        <!-- Loading -->
        <div class="ai-loading" *ngIf="aiLoading">
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
          <span>Pensando…</span>
        </div>
      </div>
    </div>

    <form class="ai-input" (ngSubmit)="sendAi()" [class.disabled]="aiLoading">
      <mat-form-field appearance="outline" class="ai-input-field">
        <mat-label>Indica qué quieres crear o cambiar…</mat-label>
       <textarea
  matInput
  rows="2"
  name="aiPrompt"
  [(ngModel)]="aiPrompt"
  placeholder='Ej: "Crea entidad Cliente con id:int PK, nombre:text; relaciona 1..* con Pedido"'
  (keydown)="maybeSend($event)"></textarea>
      </mat-form-field>

      <button mat-raised-button color="primary" type="submit" [disabled]="aiLoading || !aiPrompt.trim()">
  <mat-icon>send</mat-icon>
</button>
    </form>
  </section>
  <!-- =================== FIN WIDGET CHAT IA =================== -->
</div>
